#!/usr/bin/env bash
curl -sL https://raw.githubusercontent.com/klever1988/nanopi-openwrt/zstd-bin/zstd | sudo tee /usr/bin/zstd > /dev/null
export IMG_USER=$SOURCE_USER-$SOURCE_BRANCH-$TARGET_DEVICE
export LOOP_DEVICE=$(losetup -f)
hx=`ls $REPO_FLODER/bin/targets/*/*/*toolchain* | sed "s/openwrt/$SOURCE_USER-$SOURCE_BRANCH/g"`
xx=`ls $REPO_FLODER/bin/targets/*/*/*imagebuil* | sed "s/openwrt/$SOURCE_USER-$SOURCE_BRANCH/g"`

decompress() {
	echo "解压-部署"
	for i in {1..20}; do
		curl -sL --fail https://github.com/hong0980/OpenWrt-Cache/releases/download/cache/$IMG_USER.img.zst.0$i || break
	done | zstdmt -d -o $REPO_FLODER.img || (truncate -s 33g $REPO_FLODER.img && mkfs.btrfs -M $REPO_FLODER.img)
	sudo losetup -P --direct-io $LOOP_DEVICE $REPO_FLODER.img
	mkdir $REPO_FLODER && sudo mount -o nossd,compress=zstd $LOOP_DEVICE $REPO_FLODER

	if [ -d '$REPO_FLODER/.git' ]; then
		cd $REPO_FLODER
		rm -f zerospace
		git config --local user.email "action@github.com"
		git config --local user.name "GitHub Action"
		git fetch
		git reset --hard origin/$SOURCE_BRANCH
		git clean -df
	else
		sudo chown $USER:$(id -gn) $REPO_FLODER
		git clone -b $SOURCE_BRANCH --single-branch $REPO_URL $REPO_FLODER
	fi
}

organize_pack() {
	echo "压缩-打包"
	cp -v `find $REPO_FLODER/bin/targets/ -type f -name "*toolchain*"` output/${hx##*/} || true
	cp -v `find $REPO_FLODER/bin/targets/ -type f -name "*imagebuil*"` output/${xx##*/} || true

	cd $REPO_FLODER
	[ -f _Makefile ] && mv -f _Makefile Makefile
	make clean
	rm -rf bin tmp logs
	cd ../
	sleep 10

	# sudo mount -o remount,compress=no,nodatacow,nodatasum $REPO_FLODER
	# pushd $REPO_FLODER
	# pv /dev/zero > zerospace || true
	# sync
	# rm -f zerospace
	# popd
	# sleep 30
	# sudo umount $REPO_FLODER

	mksquashfs $REPO_FLODER $REPO_FLODER.img
	zstdmt -c --long $REPO_FLODER.img | split --numeric=1 -b 2000m - output/$IMG_USER.img.zst.
	ls -lh output
}

up_github() {
	echo "上传到github"
	export AUTH="Authorization: token $GITHUB_TOKEN"
	export cache_path='github.com/repos/hong0980/OpenWrt-Cache/releases'
	export cache_repo_id='84581161'
	while true; do
		ret=$(curl -sH "$AUTH" "https://api.$cache_path/tags/cache")
		echo $ret | jq -r '.assets[] | select(.name == "${hx##*/}").id' | xargs -n1 -i curl -X DELETE -H "$AUTH" "https://api.$cache_path/assets/{}"
		echo $ret | jq -r '.assets[] | select(.name == "${xx##*/}").id' | xargs -n1 -i curl -X DELETE -H "$AUTH" "https://api.$cache_path/assets/{}"
		echo $ret | jq -r '.assets[] | select(.name | contains ("'$IMG_USER'.img")).id' | xargs -n1 -i curl -X DELETE -H "$AUTH" "https://api.$cache_path/assets/{}"
		ls output | parallel --wc 'while true; do curl -T {} -H "$AUTH" -H "Content-Type: application/octet-stream" "https://uploads.$cache_path/$cache_repo_id/assets?name={}" && break || true; done'
		set +e
		for i in {1..20}; do
			curl -sL --fail https://github.com/hong0980/OpenWrt-Cache/releases/download/cache/$IMG_USER.img.zst.0$i || break
		done | zstdmt -d -o /dev/null
		if [ $? -eq 0 ]; then
			break
		fi
	done
	set -e
}

export AUTH="Authorization: token $GITHUB_TOKEN"
export cache_path='github.com/repos/hong0980/OpenWrt-Cache/releases'
export cache_repo_id='84581161'
ret=$(curl -sH "$AUTH" "https://api.$cache_path/tags/cache")
echo $ret

[[ $VERSION = "mini" ]] && {
	echo "OUTPUT_RELEASE=''" >>$GITHUB_ENV
} || {
	organize_pack || true
	# decompress || true
	# up_github || true
	echo "OUTPUT_RELEASE=true" >>$GITHUB_ENV
}
echo "SAVE_CACHE=''" >>$GITHUB_ENV

export -p
